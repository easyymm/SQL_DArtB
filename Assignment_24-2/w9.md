# 7. BigQuery ìž…ë¬¸ ì—°ìŠµ ë¬¸ì œ

> ðŸ”Ž **1. ê° íŠ¸ë ˆì´ë„ˆë³„ë¡œ ê°€ì§„ í¬ì¼“ëª¬ì˜ í‰ê·  ë ˆë²¨ì„ ê³„ì‚°í•˜ê³ , ê·¸ ì¤‘ í‰ê·  ë ˆë²¨ì´ ë†’ì€ TOP3 íŠ¸ë ˆì´ë„ˆì˜ ì´ë¦„ê³¼ ë³´ìœ í•œ í¬ì¼“ëª¬ì˜ ìˆ˜, í‰ê·  ë ˆë²¨ì„ ì¶œë ¥í•´ì£¼ì„¸ìš”.**  

#### ë‚´ í’€ì´
```
# TOP3 íŠ¸ë ˆì´ë„ˆì˜ IDì™€ ë³´ìœ í•œ í¬ì¼“ëª¬ì˜ ìˆ˜, í‰ê·  ë ˆë²¨
SELECT
  trainer_id,
  COUNT(pokemon_id) AS pk_cnt,
  AVG(level) AS avg_lv
FROM `basic.trainer_pokemon`
GROUP BY
  trainer_id
ORDER BY
  avg_lv DESC
LIMIT 3
;

# íŠ¸ë ˆì´ë„ˆ ì´ë¦„ ì¡°ì¸í•˜ì—¬ ê°€ì ¸ì˜´
SELECT
  t.name AS trainer_name,
  COUNT(tp.pokemon_id) AS pk_cnt,
  AVG(tp.level) AS avg_lv
FROM basic.trainer_pokemon tp
JOIN
  basic.trainer t
ON 
  t.id = tp.trainer_id
GROUP BY
  t.name
ORDER BY
  avg_lv DESC
LIMIT 3
;
```
![alt text](image.png)

#### ì •ë‹µ í’€ì´
```
# 1) íŠ¸ë ˆì´ë„ˆê°€ ë³´ìœ í•œ í¬ì¼“ëª¬ì˜ í‰ê·  ë ˆë²¨, í¬ì¼“ëª¬ì˜ ìˆ˜



```

> ðŸ”Ž **2. ê° í¬ì¼“ëª¬ íƒ€ìž…1ì„ ê¸°ì¤€ìœ¼ë¡œ ê°€ìž¥ ë§Žì´ í¬íšëœ(ë°©ì¶œ ì—¬ë¶€ ìƒê´€ì—†ìŒ) í¬ì¼“ëª¬ì˜ íƒ€ìž…1, í¬ì¼“ëª¬ì˜ ì´ë¦„ê³¼ í¬íš íšŸìˆ˜ë¥¼ ì¶œë ¥í•´ì£¼ì„¸ìš”.**

#### ë‚´ í’€ì´
```
# ê°€ìž¥ ë§Žì´ í¬íšëœ í¬ì¼“ëª¬ì˜ idì™€ í¬íš íšŸìˆ˜
SELECT
  tp.pokemon_id,
  COUNT(tp.pokemon_id) AS cap_cnt
FROM basic.trainer_pokemon tp
GROUP BY
  tp.pokemon_id
ORDER BY
  cap_cnt DESC
;

# í¬ì¼“ëª¬ì˜ íƒ€ìž…1, í¬ì¼“ëª¬ì˜ í•œêµ­ ì´ë¦„ê³¼ í¬íš íšŸìˆ˜
SELECT 
  p.type1,
  p.kor_name,
  tp_cap_cnt.cap_cnt
FROM
  (
  SELECT
    tp.pokemon_id,
    COUNT(tp.pokemon_id) AS cap_cnt
  FROM basic.trainer_pokemon tp
  GROUP BY
    tp.pokemon_id
  ) tp_cap_cnt
JOIN
  basic.pokemon p
ON
  tp_cap_cnt.pokemon_id = p.id
ORDER BY
  tp_cap_cnt.cap_cnt DESC
;
```
![alt text](image-1.png)

#### ì •ë‹µ í’€ì´
```



```


> ðŸ”Ž **3. ì „ì„¤ì˜ í¬ì¼“ëª¬ì„ ë³´ìœ í•œ íŠ¸ë ˆì´ë„ˆë“¤ì€ ì „ì„¤ì˜ í¬ì¼“ëª¬ê³¼ ì¼ë°˜ í¬ì¼“ëª¬ì„ ì–¼ë§ˆë‚˜ ë³´ìœ í•˜ê³  ìžˆì„ê¹Œìš”? (íŠ¸ë ˆì´ë„ˆì˜ ì´ë¦„ì„ ê°™ì´ ì¶œë ¥í•´ì£¼ì„¸ìš”)**


#### ë‚´ í’€ì´
```
# ì „ì„¤ì˜ í¬ì¼“ëª¬ ID
SELECT
  id AS legendary_id
FROM basic.pokemon
WHERE
  is_legendary=True
;

# ì „ì„¤ì˜ í¬ì¼“ëª¬ì„ ë³´ìœ í•œ íŠ¸ë ˆì´ë„ˆ ID ë° ë³´ìœ í•œ ì „ì„¤ì˜ í¬ì¼“ëª¬ ìˆ˜
SELECT
  tp.trainer_id,
  COUNT(tp.pokemon_id) AS lgd_cnt
FROM(
  SELECT
    id AS legendary_id
  FROM basic.pokemon
  WHERE
    is_legendary=True
    ) lgd_pk_id
JOIN
  basic.trainer_pokemon tp
ON
  tp.pokemon_id=lgd_pk_id.legendary_id
GROUP BY
  tp.trainer_id
; -- ëª¨ë‘ ì „ì„¤ì˜ í¬ì¼“ëª¬ì€ 1ë§ˆë¦¬ë§Œ ë³´ìœ í–ˆìŒì„ ì•Œ ìˆ˜ ìžˆìŒ.

# íŠ¸ë ˆì´ë„ˆ IDë³„ ì¼ë°˜ í¬ì¼“ëª¬, ì „ì„¤ í¬ì¼“ëª¬ ë³´ìœ  ìˆ˜
SELECT
  tp.trainer_id,
  SUM(CASE
    WHEN p.is_legendary=True THEN 1 ELSE 0 END) lgd_cnt,
  SUM(CASE
    WHEN p.is_legendary=False THEN 1 ELSE 0 END) nml_cnt
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
;

# íŠ¸ë ˆì´ë„ˆ ì´ë¦„ ì¶”ê°€í•˜ê¸°
SELECT
  t.name,
  tp_cnt.lgd_cnt,
  tp_cnt.nml_cnt
FROM(
  SELECT
    tp.trainer_id,
    SUM(CASE
      WHEN p.is_legendary=True THEN 1 ELSE 0 END) lgd_cnt,
    SUM(CASE
      WHEN p.is_legendary=False THEN 1 ELSE 0 END) nml_cnt
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
) tp_cnt
JOIN
  basic.trainer t
ON
  tp_cnt.trainer_id=t.id
WHERE
  tp_cnt.lgd_cnt = 1 -- ë˜ëŠ” >0
;
```
![alt text](image-2.png)

#### ì •ë‹µ í’€ì´
```



```


> ðŸ”Ž **4. ê°€ìž¥ ìŠ¹ë¦¬ê°€ ë§Žì€ íŠ¸ë ˆì´ë„ˆ ID, íŠ¸ë ˆì´ë„ˆì˜ ì´ë¦„, ìŠ¹ë¦¬í•œ íšŸìˆ˜, ë³´ìœ í•œ í¬ì¼“ëª¬ì˜ ìˆ˜, í‰ê·  í¬ì¼“ëª¬ì˜ ë ˆë²¨ì„ ì¶œë ¥í•´ì£¼ì„¸ìš”. ë‹¨, í¬ì¼“ëª¬ì˜ ë ˆë²¨ì€ ì†Œìˆ˜ì  ë‘˜ì§¸ ìžë¦¬ì—ì„œ ë°˜ì˜¬ë¦¼í•´ì£¼ì„¸ìš”. (ì°¸ê³ : ë°˜ì˜¬ë¦¼ í•¨ìˆ˜ ROUND)**

#### ë‚´ í’€ì´

```
# ìŠ¹ë¦¬í•œ íŠ¸ë ˆì´ë„ˆ IDì™€ ìŠ¹ë¦¬ íšŸìˆ˜
SELECT
  b.winner_id,
  COUNT(b.winner_id) AS win_cnt
FROM basic.battle b
GROUP BY
  b.winner_id
;
# íŠ¸ë ˆì´ë„ˆ í…Œì´ë¸” ì¡°ì¸. ê°€ìž¥ ìŠ¹ë¦¬ê°€ ë§Žì€~ì´ë¯€ë¡œ íŠ¸ë ˆì´ë„ˆ í…Œì´ë¸”ì— ë°°í‹€ í…Œì´ë¸” left join
SELECT
  t.id,
  t.name,
  COUNT(b.winner_id) AS win_cnt
FROM basic.trainer t
JOIN
  basic.battle b
ON 
  t.id=b.winner_id
GROUP BY
  t.id,
  t.name
ORDER BY
  win_cnt DESC
;

# ê°€ìž¥ ìŠ¹ë¦¬ê°€ ë§Žì€ íŠ¸ë ˆì´ë„ˆ ID, íŠ¸ë ˆì´ë„ˆì˜ ì´ë¦„, ìŠ¹ë¦¬í•œ íšŸìˆ˜, ë³´ìœ í•œ í¬ì¼“ëª¬ì˜ ìˆ˜, í‰ê·  í¬ì¼“ëª¬ì˜ ë ˆë²¨
SELECT
  wincnt.id,
  wincnt.name,
  wincnt.win_cnt,
  COUNT(tp.pokemon_id) AS pk_cnt,
  ROUND(AVG(tp.level),2) AS avg_lv
FROM(
  SELECT
    t.id,
    t.name,
    COUNT(b.winner_id) AS win_cnt
  FROM basic.trainer t
  JOIN
    basic.battle b
  ON 
    t.id=b.winner_id
  GROUP BY
    t.id,
    t.name
  ORDER BY
    win_cnt DESC
) wincnt
JOIN
  basic.trainer_pokemon tp
ON
  wincnt.id=tp.trainer_id
GROUP BY
  wincnt.id,
  wincnt.name,
  wincnt.win_cnt
ORDER BY
  wincnt.win_cnt DESC
LIMIT 1
;
```
![alt text](image-3.png)

#### ì •ë‹µ í’€ì´
```



```



> ðŸ”Ž **5. íŠ¸ë ˆì´ë„ˆê°€ ìž¡ì•˜ë˜ í¬ì¼“ëª¬ì˜ ì´ ê³µê²©ë ¥(attack)ê³¼ ë°©ì–´ë ¥(defense)ì˜ í•©ì„ ê³„ì‚°í•˜ê³ , ì´ í•©ì´ ê°€ìž¥ ë†’ì€ íŠ¸ë ˆì´ë„ˆë¥¼ ì°¾ìœ¼ì„¸ìš”.**

#### ë‚´ í’€ì´

```
# íŠ¸ë ˆì´ë„ˆ IDì™€ ì´ ê³µê²©+ë°©ì–´ë ¥ í•©, ë†’ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬
SELECT
  tp.trainer_id,
  SUM(p.attack+p.defense) AS total_physical
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
ORDER BY total_physical DESC
;

# íŠ¸ë ˆì´ë„ˆ ì´ë¦„ ì¶”ê°€
SELECT
  phy.trainer_id,
  t.name,
  phy.total_physical
FROM(
  SELECT
    tp.trainer_id,
    SUM(p.attack+p.defense) AS total_physical
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
  ) phy
JOIN 
  basic.trainer t
ON
  phy.trainer_id=t.id
ORDER BY phy.total_physical DESC
LIMIT 1
;
```
![alt text](image-4.png)

#### ì •ë‹µ í’€ì´
```



```



> ðŸ”Ž **6. ê° í¬ì¼“ëª¬ì˜ ìµœê³  ë ˆë²¨ê³¼ ìµœì € ë ˆë²¨ì„ ê³„ì‚°í•˜ê³ , ë ˆë²¨ ì°¨ì´ê°€ ê°€ìž¥ í° í¬ì¼“ëª¬ì˜ ì´ë¦„ì„ ì¶œë ¥í•˜ì„¸ìš”.**

#### ë‚´ í’€ì´

```
# í¬ì¼“ëª¬ë³„ ìµœê³ , ìµœì € ë ˆë²¨
SELECT
  pokemon_id,
  MAX(level) AS max_lv,
  MIN(level) AS min_lv
FROM basic.trainer_pokemon
GROUP BY
  pokemon_id
;

# ë ˆë²¨ ì°¨ì´ ì¶”ê°€
SELECT
  pokemon_id,
  MAX(level) AS max_lv,
  MIN(level) AS min_lv,
  (MAX(level)-MIN(level)) AS lv_diff
FROM basic.trainer_pokemon
GROUP BY
  pokemon_id
;

# í¬ì¼“ëª¬ ì´ë¦„ ì¶”ê°€, ë ˆë²¨ ì°¨ì´ ê°€ìž¥ í° í¬ì¼“ëª¬ ì¶œë ¥
SELECT
  p.kor_name,
  lv.max_lv,
  lv.min_lv,
  lv.lv_diff
FROM(
  SELECT
    pokemon_id,
    MAX(level) AS max_lv,
    MIN(level) AS min_lv,
    (MAX(level)-MIN(level)) AS lv_diff
  FROM basic.trainer_pokemon
  GROUP BY
    pokemon_id
  ) lv
JOIN
  basic.pokemon p
ON
  lv.pokemon_id=p.id
ORDER BY lv.lv_diff DESC
LIMIT 1
;
```
![alt text](image-5.png)

#### ì •ë‹µ í’€ì´
```



```



> ðŸ”Ž **7. ê° íŠ¸ë ˆì´ë„ˆê°€ ê°€ì§„ í¬ì¼“ëª¬ ì¤‘ì—ì„œ ê³µê²©ë ¥(attack)ì´ 100 ì´ìƒì¸ í¬ì¼“ëª¬ê³¼ 100 ë¯¸ë§Œì¸ í¬ì¼“ëª¬ì˜ ìˆ˜ë¥¼ ê°ê° ê³„ì‚°í•´ì£¼ì„¸ìš”. íŠ¸ë ˆì´ë„ˆì˜ ì´ë¦„ê³¼ ë‘ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” í¬ì¼“ëª¬ì˜ ìˆ˜ë¥¼ ì¶œë ¥í•´ì£¼ì„¸ìš”.**

#### ë‚´ í’€ì´

```
# íŠ¸ë ˆì´ë„ˆ ID, ê³µê²©ë ¥ 100 ì´ìƒ í¬ì¼“ëª¬ ìˆ˜, ê³µê²©ë ¥ 100 ë¯¸ë§Œ í¬ì¼“ëª¬ ìˆ˜
SELECT
  tp.trainer_id,
  SUM(CASE WHEN p.attack>=100 THEN 1 ELSE 0 END) AS atk_100ormore,
  SUM(CASE WHEN p.attack<100 THEN 1 ELSE 0 END) AS atk_below100
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
;

# íŠ¸ë ˆì´ë„ˆ ì´ë¦„ ì¶”ê°€
SELECT
  t.name,
  atk.atk_100ormore,
  atk.atk_below100
FROM(
  SELECT
    tp.trainer_id,
    SUM(CASE WHEN p.attack>=100 THEN 1 ELSE 0 END) AS atk_100ormore,
    SUM(CASE WHEN p.attack<100 THEN 1 ELSE 0 END) AS atk_below100
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
) atk
JOIN
  basic.trainer t
ON
  atk.trainer_id=t.id
;
```
![alt text](image-6.png)

#### ì •ë‹µ í’€ì´
```



```



# 8. ì•žìœ¼ë¡œ




