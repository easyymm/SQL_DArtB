# 7. BigQuery 입문 연습 문제

> 🔎 **1. 각 트레이너별로 가진 포켓몬의 평균 레벨을 계산하고, 그 중 평균 레벨이 높은 TOP3 트레이너의 이름과 보유한 포켓몬의 수, 평균 레벨을 출력해주세요.**  

#### 내 풀이
```
# TOP3 트레이너의 ID와 보유한 포켓몬의 수, 평균 레벨
SELECT
  trainer_id,
  COUNT(pokemon_id) AS pk_cnt,
  AVG(level) AS avg_lv
FROM `basic.trainer_pokemon`
GROUP BY
  trainer_id
ORDER BY
  avg_lv DESC
LIMIT 3
;

# 트레이너 이름 조인하여 가져옴
SELECT
  t.name AS trainer_name,
  COUNT(tp.pokemon_id) AS pk_cnt,
  AVG(tp.level) AS avg_lv
FROM basic.trainer_pokemon tp
JOIN
  basic.trainer t
ON 
  t.id = tp.trainer_id
GROUP BY
  t.name
ORDER BY
  avg_lv DESC
LIMIT 3
;
```
![alt text](image.png)

#### 정답 풀이
```
# 1) 트레이너가 보유한 포켓몬의 평균 레벨, 포켓몬의 수



```

> 🔎 **2. 각 포켓몬 타입1을 기준으로 가장 많이 포획된(방출 여부 상관없음) 포켓몬의 타입1, 포켓몬의 이름과 포획 횟수를 출력해주세요.**

#### 내 풀이
```
# 가장 많이 포획된 포켓몬의 id와 포획 횟수
SELECT
  tp.pokemon_id,
  COUNT(tp.pokemon_id) AS cap_cnt
FROM basic.trainer_pokemon tp
GROUP BY
  tp.pokemon_id
ORDER BY
  cap_cnt DESC
;

# 포켓몬의 타입1, 포켓몬의 한국 이름과 포획 횟수
SELECT 
  p.type1,
  p.kor_name,
  tp_cap_cnt.cap_cnt
FROM
  (
  SELECT
    tp.pokemon_id,
    COUNT(tp.pokemon_id) AS cap_cnt
  FROM basic.trainer_pokemon tp
  GROUP BY
    tp.pokemon_id
  ) tp_cap_cnt
JOIN
  basic.pokemon p
ON
  tp_cap_cnt.pokemon_id = p.id
ORDER BY
  tp_cap_cnt.cap_cnt DESC
;
```
![alt text](image-1.png)

#### 정답 풀이
```



```


> 🔎 **3. 전설의 포켓몬을 보유한 트레이너들은 전설의 포켓몬과 일반 포켓몬을 얼마나 보유하고 있을까요? (트레이너의 이름을 같이 출력해주세요)**


#### 내 풀이
```
# 전설의 포켓몬 ID
SELECT
  id AS legendary_id
FROM basic.pokemon
WHERE
  is_legendary=True
;

# 전설의 포켓몬을 보유한 트레이너 ID 및 보유한 전설의 포켓몬 수
SELECT
  tp.trainer_id,
  COUNT(tp.pokemon_id) AS lgd_cnt
FROM(
  SELECT
    id AS legendary_id
  FROM basic.pokemon
  WHERE
    is_legendary=True
    ) lgd_pk_id
JOIN
  basic.trainer_pokemon tp
ON
  tp.pokemon_id=lgd_pk_id.legendary_id
GROUP BY
  tp.trainer_id
; -- 모두 전설의 포켓몬은 1마리만 보유했음을 알 수 있음.

# 트레이너 ID별 일반 포켓몬, 전설 포켓몬 보유 수
SELECT
  tp.trainer_id,
  SUM(CASE
    WHEN p.is_legendary=True THEN 1 ELSE 0 END) lgd_cnt,
  SUM(CASE
    WHEN p.is_legendary=False THEN 1 ELSE 0 END) nml_cnt
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
;

# 트레이너 이름 추가하기
SELECT
  t.name,
  tp_cnt.lgd_cnt,
  tp_cnt.nml_cnt
FROM(
  SELECT
    tp.trainer_id,
    SUM(CASE
      WHEN p.is_legendary=True THEN 1 ELSE 0 END) lgd_cnt,
    SUM(CASE
      WHEN p.is_legendary=False THEN 1 ELSE 0 END) nml_cnt
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
) tp_cnt
JOIN
  basic.trainer t
ON
  tp_cnt.trainer_id=t.id
WHERE
  tp_cnt.lgd_cnt = 1 -- 또는 >0
;
```
![alt text](image-2.png)

#### 정답 풀이
```



```


> 🔎 **4. 가장 승리가 많은 트레이너 ID, 트레이너의 이름, 승리한 횟수, 보유한 포켓몬의 수, 평균 포켓몬의 레벨을 출력해주세요. 단, 포켓몬의 레벨은 소수점 둘째 자리에서 반올림해주세요. (참고: 반올림 함수 ROUND)**

#### 내 풀이

```
# 승리한 트레이너 ID와 승리 횟수
SELECT
  b.winner_id,
  COUNT(b.winner_id) AS win_cnt
FROM basic.battle b
GROUP BY
  b.winner_id
;
# 트레이너 테이블 조인. 가장 승리가 많은~이므로 트레이너 테이블에 배틀 테이블 left join
SELECT
  t.id,
  t.name,
  COUNT(b.winner_id) AS win_cnt
FROM basic.trainer t
JOIN
  basic.battle b
ON 
  t.id=b.winner_id
GROUP BY
  t.id,
  t.name
ORDER BY
  win_cnt DESC
;

# 가장 승리가 많은 트레이너 ID, 트레이너의 이름, 승리한 횟수, 보유한 포켓몬의 수, 평균 포켓몬의 레벨
SELECT
  wincnt.id,
  wincnt.name,
  wincnt.win_cnt,
  COUNT(tp.pokemon_id) AS pk_cnt,
  ROUND(AVG(tp.level),2) AS avg_lv
FROM(
  SELECT
    t.id,
    t.name,
    COUNT(b.winner_id) AS win_cnt
  FROM basic.trainer t
  JOIN
    basic.battle b
  ON 
    t.id=b.winner_id
  GROUP BY
    t.id,
    t.name
  ORDER BY
    win_cnt DESC
) wincnt
JOIN
  basic.trainer_pokemon tp
ON
  wincnt.id=tp.trainer_id
GROUP BY
  wincnt.id,
  wincnt.name,
  wincnt.win_cnt
ORDER BY
  wincnt.win_cnt DESC
LIMIT 1
;
```
![alt text](image-3.png)

#### 정답 풀이
```



```



> 🔎 **5. 트레이너가 잡았던 포켓몬의 총 공격력(attack)과 방어력(defense)의 합을 계산하고, 이 합이 가장 높은 트레이너를 찾으세요.**

#### 내 풀이

```
# 트레이너 ID와 총 공격+방어력 합, 높은 순서대로 정렬
SELECT
  tp.trainer_id,
  SUM(p.attack+p.defense) AS total_physical
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
ORDER BY total_physical DESC
;

# 트레이너 이름 추가
SELECT
  phy.trainer_id,
  t.name,
  phy.total_physical
FROM(
  SELECT
    tp.trainer_id,
    SUM(p.attack+p.defense) AS total_physical
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
  ) phy
JOIN 
  basic.trainer t
ON
  phy.trainer_id=t.id
ORDER BY phy.total_physical DESC
LIMIT 1
;
```
![alt text](image-4.png)

#### 정답 풀이
```



```



> 🔎 **6. 각 포켓몬의 최고 레벨과 최저 레벨을 계산하고, 레벨 차이가 가장 큰 포켓몬의 이름을 출력하세요.**

#### 내 풀이

```
# 포켓몬별 최고, 최저 레벨
SELECT
  pokemon_id,
  MAX(level) AS max_lv,
  MIN(level) AS min_lv
FROM basic.trainer_pokemon
GROUP BY
  pokemon_id
;

# 레벨 차이 추가
SELECT
  pokemon_id,
  MAX(level) AS max_lv,
  MIN(level) AS min_lv,
  (MAX(level)-MIN(level)) AS lv_diff
FROM basic.trainer_pokemon
GROUP BY
  pokemon_id
;

# 포켓몬 이름 추가, 레벨 차이 가장 큰 포켓몬 출력
SELECT
  p.kor_name,
  lv.max_lv,
  lv.min_lv,
  lv.lv_diff
FROM(
  SELECT
    pokemon_id,
    MAX(level) AS max_lv,
    MIN(level) AS min_lv,
    (MAX(level)-MIN(level)) AS lv_diff
  FROM basic.trainer_pokemon
  GROUP BY
    pokemon_id
  ) lv
JOIN
  basic.pokemon p
ON
  lv.pokemon_id=p.id
ORDER BY lv.lv_diff DESC
LIMIT 1
;
```
![alt text](image-5.png)

#### 정답 풀이
```



```



> 🔎 **7. 각 트레이너가 가진 포켓몬 중에서 공격력(attack)이 100 이상인 포켓몬과 100 미만인 포켓몬의 수를 각각 계산해주세요. 트레이너의 이름과 두 조건에 해당하는 포켓몬의 수를 출력해주세요.**

#### 내 풀이

```
# 트레이너 ID, 공격력 100 이상 포켓몬 수, 공격력 100 미만 포켓몬 수
SELECT
  tp.trainer_id,
  SUM(CASE WHEN p.attack>=100 THEN 1 ELSE 0 END) AS atk_100ormore,
  SUM(CASE WHEN p.attack<100 THEN 1 ELSE 0 END) AS atk_below100
FROM basic.trainer_pokemon tp
JOIN
  basic.pokemon p
ON
  tp.pokemon_id=p.id
GROUP BY
  tp.trainer_id
;

# 트레이너 이름 추가
SELECT
  t.name,
  atk.atk_100ormore,
  atk.atk_below100
FROM(
  SELECT
    tp.trainer_id,
    SUM(CASE WHEN p.attack>=100 THEN 1 ELSE 0 END) AS atk_100ormore,
    SUM(CASE WHEN p.attack<100 THEN 1 ELSE 0 END) AS atk_below100
  FROM basic.trainer_pokemon tp
  JOIN
    basic.pokemon p
  ON
    tp.pokemon_id=p.id
  GROUP BY
    tp.trainer_id
) atk
JOIN
  basic.trainer t
ON
  atk.trainer_id=t.id
;
```
![alt text](image-6.png)

#### 정답 풀이
```



```



# 8. 앞으로




